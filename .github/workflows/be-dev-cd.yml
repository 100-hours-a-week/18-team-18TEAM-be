name: CD - DEV (BE)

on:
  push:
    branches: ["develop"]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: be-dev-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 20

    env:
      APP_NAME: "BizKit-BE"
      APP_STAGE: dev
      HEALTH_URL: http://127.0.0.1:8080/actuator/health

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Semantic Release (dev)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Read version from gradle.properties
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(grep -E '^version=' gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build (Gradle)
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew clean build -x test

      - name: Configure AWS Credentials (Access Key)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload Release Artifact to S3 (BE)
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}
          BUCKET="${{ secrets.S3_BUCKET }}"

          JAR=$(ls -1 build/libs/*.jar | head -n 1)
          RELEASE_KEY="${{ secrets.S3_PREFIX }}/${APP_STAGE}/releases/be/${VERSION}/bizkit-be-${VERSION}.jar"

          aws s3 cp "$JAR" "s3://$BUCKET/$RELEASE_KEY" --cache-control no-cache

          echo "BUCKET=$BUCKET" >> "$GITHUB_ENV"
          echo "RELEASE_KEY=$RELEASE_KEY" >> "$GITHUB_ENV"

      - name: Build CodeDeploy bundle (BE)
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}

          rm -rf bundle && mkdir -p bundle/deploy

          cp codedeploy/be/appspec.yml bundle/appspec.yml
          cp deploy-be.sh bundle/deploy-be.sh
          cp codedeploy/be/hooks/start.sh bundle/deploy/start.sh
          cp codedeploy/be/hooks/stop.sh bundle/deploy/stop.sh
          cp codedeploy/be/hooks/validate.sh bundle/deploy/validate.sh

          cat > bundle/deploy/env.sh <<EOF
          RELEASE_ID='${VERSION}'
          BUCKET='${BUCKET}'
          RELEASE_KEY='${RELEASE_KEY}'
          EOF

          (cd bundle && zip -r ../bundle.zip .)
          unzip -l bundle.zip

      - name: Upload bundle.zip to S3
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}
          BUNDLE_KEY="${{ secrets.S3_PREFIX }}/${APP_STAGE}/codedeploy/be/${VERSION}/bundle-${{ github.run_id }}.zip"
          aws s3 cp bundle.zip "s3://$BUCKET/$BUNDLE_KEY"
          echo "BUNDLE_KEY=$BUNDLE_KEY" >> "$GITHUB_ENV"

      - name: Create CodeDeploy deployment & wait
        shell: bash
        run: |
          set -euo pipefail
          APP="${{ secrets.CODEDEPLOY_APP_BE_DEV }}"
          DG="${{ secrets.CODEDEPLOY_DG_BE_DEV }}"

          DEPLOY_ID="$(aws deploy create-deployment \
            --application-name "$APP" \
            --deployment-group-name "$DG" \
            --s3-location bucket="$BUCKET",key="$BUNDLE_KEY",bundleType=zip \
            --file-exists-behavior OVERWRITE \
            --query "deploymentId" --output text)"

          echo "deploymentId=$DEPLOY_ID"
          aws deploy wait deployment-successful --deployment-id "$DEPLOY_ID"
          echo "CodeDeploy SUCCESS"
